<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Gov. Umo Eno – Your AI Tutor 🇳🇬</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ---------- BASE ---------- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Nunito',sans-serif;background:#f5f7fa}
body{display:flex;flex-direction:column;}

/* ---------- HEADER ---------- */
header{position:fixed;inset:0 0 auto;z-index:1000;
  padding:1rem env(safe-area-inset-right) 1rem env(safe-area-inset-left);
  background:#2563eb;color:#fff;text-align:center;line-height:1.2;
  font-size:1.4rem;font-weight:700;box-shadow:0 2px 5px rgba(0,0,0,.1)}
header small{display:block;font-size:.7rem;font-weight:400}

/* ---------- VOICE TOGGLE ---------- */
#speakToggleWrapper{position:fixed;top:1rem;right:1rem;z-index:1001;
  font-size:.85rem;color:#fff}

/* ---------- MAIN WRAPPER ---------- */
main#wrapper{flex:1;display:flex;gap:.5rem;max-width:1200px;width:100%;
  margin:auto;min-height:0;
  padding:5rem .5rem calc(6.2rem + env(safe-area-inset-bottom));}

/* ---------- SIDEBARS ---------- */
aside,
#visuals {
  width: 20%;
  min-width: 180px;      /* <-- prevents it from vanishing */
  background: #fff;
  border-radius: 16px;
  padding: 0.5rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 0.95rem;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

#visuals h3 {
  margin-bottom: 0.3rem;
}

/* ---------- CHAT ---------- */
#chatBoxWrapper{flex:2.5;background:#fff;border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);padding:.5rem;
  display:flex;flex-direction:column;min-height:0;}
#chat{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:.6rem;padding-right:.5rem;scroll-behavior:smooth}

/* ---------- BUBBLES ---------- */
.message-row{display:flex;align-items:flex-start}
.message-row.user{justify-content:flex-end}
.avatar{width:36px;height:36px;border-radius:50%;margin:0 6px;flex-shrink:0}
.user .avatar{background:#bae6fd}
.assistant .avatar{background:url('https://cdn-icons-png.flaticon.com/512/1995/1995471.png') center/cover}
.bubble{max-width:75%;padding:.6rem .9rem;border-radius:16px;font-size:1rem;line-height:1.45;white-space:pre-wrap}
.bubble.user{background:#c7f0d8;border-bottom-right-radius:0;position:relative}
.bubble.user::after{content:attr(data-name);font-size:.75rem;color:#1e3a8a;position:absolute;bottom:-1.2rem;right:1rem}
.bubble.assistant{background:#e0e7ff;border-bottom-left-radius:0}

/* ---------- INPUT BAR ---------- */
form{position:fixed;inset:auto 0 env(safe-area-inset-bottom);z-index:1000;
  max-width:1200px;margin:auto;background:#fff;border-top:1px solid #ddd;
  padding:.6rem 1rem .6rem 1rem;display:flex;gap:.6rem;align-items:center;
  border-radius:12px 12px 0 0}
textarea{flex:1;border:1px solid #ccc;border-radius:12px;padding:.6rem 1rem;
  font-size:1rem;min-height:3rem;max-height:8rem;overflow:auto;resize:none}
textarea.auto{height:auto}
#controls{display:flex;flex-direction:column;align-items:center;gap:.3rem}
.top-buttons{display:flex;gap:.4rem}
button{background:#2563eb;color:#fff;border:none;border-radius:10px;
  padding:.6rem 1rem;font-size:1rem;cursor:pointer}
.clear-button{background:orange;width:100%;font-size:.85rem;padding:.3rem .8rem}

/* ---------- MOBILE ---------- */
@media(max-width:768px){
  aside,#visuals{display:none}
  main#wrapper{flex-direction:column;align-items:stretch;padding:4.7rem 1rem calc(7.3rem + env(safe-area-inset-bottom));}
}

/* ---------- CONFETTI ---------- */
@keyframes floatUp{0%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,-140px)}}
#cssConfetti{position:fixed;left:50%;bottom:60px;z-index:9999;font-size:2.6rem;pointer-events:none;animation:floatUp 1.3s ease-out forwards}
</style>
</head>
<body>
<header>Arise Education<small>Powered by Akwa Ibom State Government</small></header>
<div id="speakToggleWrapper">
  <label><input type="checkbox" id="speakToggle"> 🔊 Gov. Umo Eno Speaks</label>
</div>

<main id="wrapper">
  <aside id="leftSidebar">
    <h3 id="knowledgeHeader" style="display:none">📘 Knowledge Tree</h3>
    <div id="knowledgeContent" style="overflow:auto">
      <div id="aboutMrE">
        <p><strong>I am Gov. Umo Eno AI</strong></p>
        <p>Your friendly AI tutor! 🌟<br>I’ll help you learn step by step.<br>Feel free to interrupt, ask questions and relax!</p>
        <p><strong>Abasi Sosong O!</strong></p>
      </div>
      <div id="treeContents" style="margin-top:.8rem"></div>
      <div id="progressVisual" style="margin-top:1rem;font-weight:bold"></div>
      <div id="progressFeedback" style="font-size:.85rem;color:#4b5563;margin-top:.3rem"></div>
    </div>
  </aside>

  <div id="chatBoxWrapper"><div id="chat"></div></div>

  <aside id="visuals">
    <h3>🔍 Topic visuals</h3>
    <p>Coming soon.</p>
  </aside>
</main>

<form id="chat-form">
  <textarea id="messageInput" placeholder="Type your message..." required></textarea>
  <div id="controls">
    <div class="top-buttons">
      <button type="submit">Send</button>
      <button type="button" id="micButton">🎤</button>
    </div>
    <button type="button" class="clear-button" id="clearButton">🗑️ Clear</button>
  </div>
</form>

<script>
/* ---------- DOM ---------- */
const chatBox = document.getElementById('chat');
const form    = document.getElementById('chat-form');
const input   = document.getElementById('messageInput');
const micBtn  = document.getElementById('micButton');
const clearBtn= document.getElementById('clearButton');
const speakToggle = document.getElementById('speakToggle');

/* ---------- STATE ---------- */
let history = [];
let student = '';
let thinking = null;
let totalNodes = 0;         /* <‑‑‑ added */

/* ---------- HELPERS ---------- */
function addMsg(text, role){
  const row = document.createElement('div'); row.className = `message-row ${role}`;
  const av  = document.createElement('div'); av.className  = `avatar ${role}`;
  const bub = document.createElement('div'); bub.className = `bubble ${role}`;
  bub.innerHTML = text
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.*?)\*/g,'<em>$1</em>');
  if (role==='user') bub.setAttribute('data-name', student);
  row.append(role==='assistant'?av:bub, role==='assistant'?bub:av);
  chatBox.appendChild(row);
  chatBox.scrollTop = chatBox.scrollHeight;
  return row; // Return the created element
}
function speak(t){ if(!speakToggle.checked) return;
  const u = new SpeechSynthesisUtterance(t); u.lang='en-NG'; speechSynthesis.speak(u); }
function confetti(){ const d=document.createElement('div'); d.id='cssConfetti'; d.textContent='🎉';
  document.body.append(d); setTimeout(()=>d.remove(),1300); }

/* ---------- PROGRESS BAR ---------- */
function progBar(state='⬜', done=0, total){
  if(!total) total = (state.match(/🟢|🟧|⬜/g)||[]).length;
  document.getElementById('progressVisual').textContent =
      `🧠 Progress: ${state} (${done}/${total} mastered!)`;
  document.getElementById('progressFeedback').textContent =
      done===0 ? "Let's begin! 🚀" :
      done===total ? "Woohoo 🎉 Topic mastered!" :
      "Great job! Keep going 🌟";
}

/* ---------- KNOWLEDGE TREE ---------- */
function setTree(txt){
  const lines = txt.split('\n').filter(l=>/^\d+\./.test(l));
  if(!lines.length) return;
  if (totalNodes === 0) {
    totalNodes = lines.length;
  }
  document.getElementById('knowledgeHeader').style.display='block';
  document.getElementById('aboutMrE').style.display='none';
  document.getElementById('treeContents').innerHTML =
      '<ol style="padding-left:1rem">'+
      lines.map(l=>`<li>${l.replace(/^\d+\.\s*/,'')}</li>`).join('')+'</ol>';
  totalNodes = lines.length;
  progBar('⬜'.repeat(totalNodes), 0, totalNodes);
}

/* ---------- HANDLE ASSISTANT ---------- */
function handleAI(reply) {
  // 1) Show reply in chat + speak it
  addMsg(reply, 'assistant');
  speak(reply);

  // 2) VISUALS PANE: reset with header + fallback
  const visuals = document.getElementById('visuals');
  visuals.innerHTML = `
    <h3>🔍 Topic visuals</h3>
    <p>Coming soon.</p>
  `;

  // 2a) Try to find an image URL
  const imgMatch = reply.match(/(https?:\/\/\S+\.(?:png|jpe?g|gif))/i);
  if (imgMatch) {
    visuals.innerHTML = `<h3>🔍 Topic visuals</h3>`;  // clear fallback
    const img = document.createElement('img');
    img.src = imgMatch[1];
    img.style.cssText = 'width:100%;border-radius:8px;margin-top:8px;';
    visuals.appendChild(img);
  }

  // 2b) Try to find a YouTube link
  const ytMatch = reply.match(/youtu(?:be\.com\/watch\?v=|\.be\/)([\w-]+)/i);
  if (ytMatch) {
    // if we already put an <img>, keep it; otherwise clear fallback header
    if (!imgMatch) visuals.innerHTML = `<h3>🔍 Topic visuals</h3>`;
    const iframe = document.createElement('iframe');
    iframe.width = '100%';
    iframe.height = '200';
    iframe.src = `https://www.youtube.com/embed/${ytMatch[1]}`;
    iframe.allow =
      'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
    iframe.setAttribute('allowfullscreen', '');
    iframe.style.cssText = 'margin-top:8px;border-radius:8px;';
    visuals.appendChild(iframe);
  }

  // 3) KNOWLEDGE TREE
  const idx = reply.indexOf('Knowledge Tree:');
  if (idx !== -1) {
    const treeBlock = reply.slice(idx).split('\n').slice(1).join('\n');
    setTree(treeBlock);
  }

  // 4) PROGRESS BAR
  const m = reply.match(/([🟢🟧⬜]{3,})/);
  if (m) {
    let state = m[1];
    if (totalNodes && state.length < totalNodes) {
      state = state.padEnd(totalNodes, '⬜');
    }
    const mastered = (state.match(/🟢/g) || []).length;
    progBar(state, mastered, totalNodes || state.length);
  }

  // 5) FINAL CELEBRATION
  if (/You\s+MASTERED/i.test(reply)) {
    confetti();
  }
}

/* ---------- SEND ---------- */
async function send(msg){
  if(!student && /my name is (\w+)/i.test(msg))
      student = msg.match(/my name is (\w+)/i)[1];

  history.push({role:'user',content:msg});
  addMsg(msg,'user');

  thinking = addMsg('💭 Gov. is thinking...','assistant');

  try{
    const res = await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({conversation:history})
    });
    const data = await res.json();
    let rep = data.message || '';
    rep = rep.replace(/Do you understand\?.*?/gi,'Do you understand?');

    history.push({role:'assistant',content:rep});
    if(thinking){ thinking.remove(); thinking = null; }
    handleAI(rep);

  }catch{
    if(thinking){ thinking.remove(); thinking = null; }
    addMsg('⚠️ Something went wrong','assistant');
  }
}

/* ---------- INIT ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  setTimeout(()=>{
    const intro="Welcome 🎉 What’s your name, grade, and what topic would you like to learn today?";
    history.push({role:'assistant',content:intro});
    addMsg(intro,'assistant');
  },200);
});

/* ---------- EVENTS ---------- */
form.onsubmit = e=>{
  e.preventDefault();
  if(input.value.trim()){
    send(input.value.trim());
    input.value='';
  }
};
input.onkeydown = e=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    form.requestSubmit();
  }
};
input.oninput = ()=>{
  input.style.height='auto';
  input.style.height = input.scrollHeight+'px';
};
clearBtn.onclick = ()=>{
  history=[]; chatBox.innerHTML=''; student='';
  document.dispatchEvent(new Event('DOMContentLoaded'));
};

/* ---------- VOICE ---------- */
const rec = 'webkitSpeechRecognition' in window ? new webkitSpeechRecognition() : null;
if(rec){
  rec.lang='en-NG';
  micBtn.onclick=()=>{ rec.start(); micBtn.textContent='🎙️'; };
  rec.onresult=e=>{
    let t=''; for(let i=e.resultIndex;i<e.results.length;++i)
      if(e.results[i].isFinal) t+=e.results[i][0].transcript;
    if(t.trim()){ send(t.trim()); input.value=''; }
    micBtn.textContent='🎤';
  };
  rec.onerror = rec.onend = ()=> micBtn.textContent='🎤';
}else{
  micBtn.disabled=true; micBtn.title='Voice unsupported';
}
</script>
</body>
</html>
