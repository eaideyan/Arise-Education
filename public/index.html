<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gov.Â UmoÂ Eno â€“ Your AI Tutor ğŸ‡³ğŸ‡¬</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* ---------- Base layout ---------- */
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:'Nunito',sans-serif;background:#f5f7fa}
    body{display:flex;flex-direction:column}

    /* ---------- Top bar ---------- */
    header{
      position:fixed;top:0;left:0;right:0;z-index:1000;
      padding:1rem;text-align:center;line-height:1.2;
      background:#2563eb;color:#fff;font-weight:700;
      box-shadow:0 2px 5px rgba(0,0,0,.1)
    }
    #speakToggleWrapper{
      position:fixed;top:1rem;right:1rem;z-index:1001;
      font-size:.85rem;color:#fff
    }

    /* ---------- Main wrapper ---------- */
    main#wrapper{
      max-width:1200px;margin:auto;width:100%;
      display:flex;gap:.5rem;justify-content:center;
      padding:5rem .5rem 6rem
    }
    aside,#visuals{
      width:20%;background:#fff;border-radius:16px;padding:.5rem;
      box-shadow:0 2px 6px rgba(0,0,0,.08);font-size:.95rem
    }
    #chatBoxWrapper{
      flex:2.5;background:#fff;border-radius:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);padding:.5rem;
      display:flex;flex-direction:column;height:70vh
    }
    #chat{flex-grow:1;overflow-y:auto;display:flex;flex-direction:column;gap:.6rem;padding-right:.5rem}

    /* ---------- Chat bubbles ---------- */
    .message-row{display:flex;align-items:flex-start}
    .message-row.user{justify-content:flex-end}
    .avatar{width:36px;height:36px;border-radius:50%;margin:0 6px;flex-shrink:0}
    .user .avatar{background:#bae6fd}
    .assistant .avatar{
      background:url('https://cdn-icons-png.flaticon.com/512/1995/1995471.png') center/cover
    }
    .bubble{
      max-width:75%;padding:.6rem .9rem;border-radius:16px;
      font-size:1rem;line-height:1.45;white-space:pre-wrap
    }
    .bubble.user{background:#c7f0d8;border-bottom-right-radius:0;position:relative}
    .bubble.user::after{
      content:attr(data-name);font-size:.75rem;color:#1e3a8a;
      position:absolute;bottom:-1.2rem;right:1rem
    }
    .bubble.assistant{background:#e0e7ff;border-bottom-left-radius:0}

    /* ---------- Input area ---------- */
    form{
      position:fixed;left:0;right:0;bottom:0;margin:auto;max-width:1200px;
      background:#fff;padding:.6rem 1rem;border-top:1px solid #ddd;
      display:flex;gap:.6rem;align-items:center;border-radius:12px 12px 0 0
    }
    textarea{
      flex:1;font-size:1rem;border-radius:12px;border:1px solid #ccc;
      padding:.6rem 1rem;height:3rem;resize:none
    }
    #controls{display:flex;flex-direction:column;align-items:center;gap:.3rem}
    .top-buttons{display:flex;gap:.4rem}
    button{
      background:#2563eb;color:#fff;border:none;border-radius:10px;
      padding:.6rem 1rem;font-size:1rem;cursor:pointer
    }
    .clear-button{background:orange;width:100%;font-size:.85rem;padding:.3rem .8rem}

    /* ---------- Responsive ---------- */
    @media(max-width:768px){
      aside,#visuals{display:none}
      main#wrapper{flex-direction:column;align-items:stretch;padding:1rem}
    }

    /* ---------- Lightweight ğŸ‰ sprinkle ---------- */
    @keyframes floatUp{
      0%{opacity:1;transform:translate(-50%,0)}
      100%{opacity:0;transform:translate(-50%,-140px)}
    }
    #cssConfetti{
      position:fixed;left:50%;bottom:60px;z-index:9999;
      font-size:2.6rem;pointer-events:none;
      animation:floatUp 1.3s ease-out forwards
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div style="font-size:1.4rem">Arise Education</div>
    <div style="font-size:.65rem;font-weight:400">Powered by AkwaÂ Ibom State Government</div>
  </header>
  <div id="speakToggleWrapper">
    <label><input type="checkbox" id="speakToggle"> ğŸ”Š Gov.Â UmoÂ Eno Speaks</label>
  </div>

  <!-- Main -->
  <main id="wrapper">
    <!-- Left sidebar -->
    <aside id="leftSidebar">
      <h3 id="knowledgeHeader" style="display:none">ğŸ“˜ Knowledge Tree</h3>

      <div id="knowledgeContent">
        <div id="aboutMrE">
          <p><strong>I am Gov.Â UmoÂ EnoÂ AI</strong></p>
          <p>Your friendly AI tutor! ğŸŒŸ<br>
             Iâ€™ll help you learn one step at a time. Feel free to interrupt,<br>
             ask questions and clarify. This space is oursâ€”so relax &amp; learn!</p>
          <p><strong>AbasiÂ SosongÂ O!</strong></p>
        </div>

        <div id="treeContents" style="margin-top:.8rem"></div>

        <div id="progressVisual"  style="margin-top:1rem;font-weight:bold"></div>
        <div id="progressFeedback"style="font-size:.85rem;color:#4b5563;margin-top:.3rem"></div>
      </div>
    </aside>

    <!-- Chat column -->
    <div id="chatBoxWrapper"><div id="chat"></div></div>

    <!-- Right sidebar -->
    <aside id="visuals">
      <h3>ğŸ” Topic visuals</h3>
      <p>Coming soon.</p>
    </aside>
  </main>

  <!-- Input -->
  <form id="chat-form">
    <textarea id="messageInput" placeholder="Type your message..." required></textarea>

    <div id="controls">
      <div class="top-buttons">
        <button type="submit">Send</button>
        <button type="button" id="micButton">ğŸ¤</button>
      </div>
      <button type="button" class="clear-button" id="clearButton">ğŸ—‘ï¸ Clear</button>
    </div>
  </form>

  <!-- Script -->
  <script>
    const chatBox       = document.getElementById('chat');
    const form          = document.getElementById('chat-form');
    const input         = document.getElementById('messageInput');
    const micButton     = document.getElementById('micButton');
    const clearButton   = document.getElementById('clearButton');
    const speakToggle   = document.getElementById('speakToggle');

    let conversation = [];
    let studentName  = '';
    let thinkingRow  = null;

    /* ---------- Sprinkle helper ---------- */
    function burstConfetti(){
      const el=document.createElement('div');
      el.id='cssConfetti';
      el.textContent='ğŸ‰';
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),1400);
    }

    /* ---------- Chat helpers ---------- */
    function addMessage(content, role) {
      const row     = document.createElement('div');
      row.className = `message-row ${role}`;

      const avatar  = document.createElement('div');
      avatar.className = `avatar ${role}`;

      const bubble  = document.createElement('div');
      bubble.className = `bubble ${role}`;
      bubble.innerHTML = content
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.*?)\*/g,'<em>$1</em>');

      if (role === 'user') bubble.setAttribute('data-name', studentName || '');

      row.appendChild(role === 'assistant' ? avatar : bubble);
      row.appendChild(role === 'assistant' ? bubble  : avatar);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
      return row;
    }

    function speak(text){
      if(!speakToggle.checked) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang  = 'en-NG'; u.pitch = 1; u.rate = 1;
      speechSynthesis.speak(u);
    }

    /* ---------- Progressâ€‘bar helpers ---------- */
    function updateProgressBar(state='â¬œ', mastered=0, total){
      if(total===undefined) total=(state.match(/ğŸŸ¢|ğŸŸ§|â¬œ/g)||[]).length;
      document.getElementById('progressVisual').textContent =
        `ğŸ§  Progress: ${state} (${mastered}/${total} mastered!)`;

      document.getElementById('progressFeedback').textContent =
        mastered===0     ? "Let's begin your learning journey! ğŸš€" :
        mastered===total ? "Woohoo! ğŸ‰ You've completed the topic!" :
                           "Great job! Keep going, you're doing well! ğŸŒŸ";
    }

    function updateProgressBarFromMessage(msg){
      const m = msg.match(/ğŸ§  Progress:\s*(.*?)\s*\((\d+)\/(\d+)\s+mastered!\)/);
      if(m){
        const[,state,done,total]=m;
        return updateProgressBar(state,+done,+total);
      }
      // Final mastery fallback
      if(/You\s+MASTERED/i.test(msg)){
        burstConfetti();
        const bar=document.getElementById('progressVisual').textContent;
        const total=+(bar.match(/\d+\/(\d+)/)||[,'0'])[1];
        if(total) updateProgressBar('ğŸŸ¢'.repeat(total), total, total);
      }
    }

    function updateKnowledgeTreeInSidebar(treeText){
      const header=document.getElementById('knowledgeHeader');
      const about =document.getElementById('aboutMrE');
      const tree  =document.getElementById('treeContents');

      const lines=treeText.split('\n').filter(l=>/^\d+\./.test(l.trim()));
      if(lines.length){
        header.style.display='block'; about.style.display='none';
        tree.innerHTML='<ol style="padding-left:1rem;">'+
          lines.map(l=>`<li>${l.trim().replace(/^\d+\.\s*/,'')}</li>`).join('')+
          '</ol>';
        updateProgressBar('â¬œ'.repeat(lines.length),0,lines.length);
      }
    }

    /* ---------- Handle AI reply ---------- */
    function handleAssistantReply(reply){
      addMessage(reply,'assistant'); speak(reply);

      const idx=reply.indexOf('Knowledge Tree:');
      if(idx!==-1){
        const section=reply.slice(idx).split('\n').slice(1).join('\n');
        updateKnowledgeTreeInSidebar(section);
      }
      updateProgressBarFromMessage(reply);
    }

    /* ---------- Send message to backend ---------- */
    async function sendMessage(msg){
      if(!studentName && /my name is (\w+)/i.test(msg)){
        studentName=msg.match(/my name is (\w+)/i)[1];
      }
      conversation.push({role:'user',content:msg});
      addMessage(msg,'user');

      thinkingRow=addMessage('ğŸ’­ Gov. is thinking...','assistant');

      try{
        const res  = await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversation})});
        const data = await res.json();
        let reply  = data.message || '';
        reply      = reply.replace(/Do you understand\?.*?/gi,'Do you understand?');

        conversation.push({role:'assistant',content:reply});
        if(thinkingRow) thinkingRow.remove();
        handleAssistantReply(reply);
      }catch{
        if(thinkingRow) thinkingRow.remove();
        addMessage('âš ï¸ Something went wrong. Please try again later.','assistant');
      }
    }

    /* ---------- Init ---------- */
    window.onload=()=>{
      const intro="Welcome ğŸ‰  Whatâ€™s your name, grade, and what topic would you like to learn today?";
      conversation.push({role:'assistant',content:intro});
      addMessage(intro,'assistant');
    };

    form.addEventListener('submit',e=>{
      e.preventDefault();
      const msg=input.value.trim();
      if(msg){input.value='';sendMessage(msg);}
    });
    input.addEventListener('keydown',e=>{
      if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();form.dispatchEvent(new Event('submit')); }
    });

    clearButton.addEventListener('click',()=>{
      conversation=[];chatBox.innerHTML='';studentName='';window.onload();
    });

    /* ---------- Voice input (unchanged) ---------- */
    const recognition='webkitSpeechRecognition'in window?new webkitSpeechRecognition():null;
    if(recognition){
      recognition.lang='en-NG';recognition.continuous=false;recognition.interimResults=true;
      micButton.addEventListener('click',()=>{recognition.start();micButton.textContent='ğŸ™ï¸'});
      recognition.onresult=e=>{
        let t='';for(let i=e.resultIndex;i<e.results.length;++i){
          if(e.results[i].isFinal) t+=e.results[i][0].transcript;
        }
        if(t.trim()){input.value=t;sendMessage(t);input.value='';}
        micButton.textContent='ğŸ¤';
      };
      recognition.onerror=recognition.onend=()=>{micButton.textContent='ğŸ¤'};
    }else{
      micButton.disabled=true;
      micButton.title='Voice input not supported on this browser.';
    }
  </script>
</body>
</html>
