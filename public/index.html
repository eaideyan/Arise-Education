<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Gov.¬†Umo¬†Eno ‚Äì Your¬†AI¬†Tutor üá≥üá¨</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ---------- RESET & BASE ---------- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Nunito',sans-serif;background:#f5f7fa;overscroll-behavior:none;}
body{display:flex;flex-direction:column;}
a{color:inherit;text-decoration:none}

/* ---------- HEADER ---------- */
header{
  position:fixed;top:0;left:0;right:0;z-index:1000;
  padding:1rem env(safe-area-inset-right) 1rem env(safe-area-inset-left);
  background:#2563eb;color:#fff;text-align:center;
  font-size:1.4rem;font-weight:700;line-height:1.2;
  box-shadow:0 2px 5px rgba(0,0,0,.1);
}
header small{display:block;font-size:.7rem;font-weight:400}

/* ---------- SPEAK TOGGLE ---------- */
#speakToggleWrapper{
  position:fixed;top:1rem;right:1rem;z-index:1001;
  font-size:.85rem;color:#fff;
}

/* ---------- MAIN LAYOUT ---------- */
main#wrapper{
  flex:1;                         /* take remaining height */
  display:flex;gap:.5rem;justify-content:center;
  max-width:1200px;width:100%;margin:auto;
  padding:5rem .5rem calc(6rem + env(safe-area-inset-bottom));
  min-height:0;                   /* allow children to shrink for scroll */
}

/* ---------- SIDEBARS ---------- */
aside,#visuals{
  width:20%;background:#fff;border-radius:16px;padding:.5rem;
  box-shadow:0 2px 6px rgba(0,0,0,.08);font-size:.95rem;
  display:flex;flex-direction:column;min-height:0;
}
#visuals h3{margin-bottom:.3rem}

/* ---------- CHAT COLUMN ---------- */
#chatBoxWrapper{
  flex:2.5;display:flex;flex-direction:column;min-height:0;
  background:#fff;border-radius:16px;padding:.5rem;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
}
#chat{
  flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;
  display:flex;flex-direction:column;gap:.6rem;
  padding-right:.5rem;scroll-behavior:smooth;
}

/* ---------- CHAT BUBBLES ---------- */
.message-row{display:flex;align-items:flex-start;}
.message-row.user{justify-content:flex-end}
.avatar{width:36px;height:36px;border-radius:50%;margin:0 6px;flex-shrink:0}
.user .avatar{background:#bae6fd}
.assistant .avatar{
  background:url('https://cdn-icons-png.flaticon.com/512/1995/1995471.png') center/cover}
.bubble{
  max-width:75%;padding:.6rem .9rem;border-radius:16px;
  font-size:1rem;line-height:1.45;white-space:pre-wrap}
.bubble.user{background:#c7f0d8;border-bottom-right-radius:0;position:relative}
.bubble.user::after{
  content:attr(data-name);font-size:.75rem;color:#1e3a8a;
  position:absolute;bottom:-1.2rem;right:1rem}
.bubble.assistant{background:#e0e7ff;border-bottom-left-radius:0}

/* ---------- INPUT BAR ---------- */
form{
  position:fixed;left:0;right:0;bottom:0;z-index:1000;
  max-width:1200px;margin:auto;
  background:#fff;padding:.6rem 1rem env(safe-area-inset-bottom);
  border-top:1px solid #ddd;border-radius:12px 12px 0 0;
  display:flex;gap:.6rem;align-items:center;
}
textarea{
  flex:1;border:1px solid #ccc;border-radius:12px;
  font-size:1rem;padding:.6rem 1rem;height:3rem;resize:none;min-height:3rem;
}
textarea.auto{height:auto}             /* auto-expand flag */
#controls{display:flex;flex-direction:column;gap:.3rem;align-items:center}
.top-buttons{display:flex;gap:.4rem}
button{
  background:#2563eb;color:#fff;border:none;border-radius:10px;
  font-size:1rem;padding:.6rem 1rem;cursor:pointer}
.clear-button{background:orange;width:100%;font-size:.85rem;padding:.3rem .8rem}

/* ---------- MOBILE LAYOUT ---------- */
@media(max-width:768px){
  aside,#visuals{display:none}
  main#wrapper{flex-direction:column;align-items:stretch;padding:4.5rem 1rem 7rem;}
}

/* ---------- CELEBRATION SPRINKLE ---------- */
@keyframes floatUp{0%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,-140px)}}
#cssConfetti{
  position:fixed;left:50%;bottom:60px;
  z-index:9999;font-size:2.6rem;pointer-events:none;
  animation:floatUp 1.3s ease-out forwards}
</style>
</head>
<body>
<!-- HEADER -->
<header>
  Arise Education
  <small>Powered by Akwa¬†Ibom State Government</small>
</header>
<div id="speakToggleWrapper">
  <label><input type="checkbox" id="speakToggle"> üîä Gov.¬†Umo¬†Eno¬†Speaks</label>
</div>

<!-- MAIN WRAPPER -->
<main id="wrapper">
  <!-- LEFT SIDEBAR -->
  <aside id="leftSidebar">
    <h3 id="knowledgeHeader" style="display:none">üìò Knowledge Tree</h3>
    <div id="knowledgeContent" style="overflow-y:auto">
      <div id="aboutMrE">
        <p><strong>I am Gov. Umo¬†Eno¬†AI</strong></p>
        <p>Your friendly AI tutor! üåü<br>
           I‚Äôll help you learn step by step. Feel free to interrupt,<br>
           ask questions and relax!</p>
        <p><strong>Abasi¬†Sosong¬†O!</strong></p>
      </div>
      <div id="treeContents" style="margin-top:.8rem"></div>
      <div id="progressVisual" style="margin-top:1rem;font-weight:bold"></div>
      <div id="progressFeedback" style="font-size:.85rem;color:#4b5563;margin-top:.3rem"></div>
    </div>
  </aside>

  <!-- CHAT COLUMN -->
  <div id="chatBoxWrapper"><div id="chat"></div></div>

  <!-- RIGHT SIDEBAR -->
  <aside id="visuals">
    <h3>üîç Topic visuals</h3>
    <p>Coming¬†soon.</p>
  </aside>
</main>

<!-- INPUT BAR -->
<form id="chat-form">
  <textarea id="messageInput" placeholder="Type your message..." required></textarea>
  <div id="controls">
    <div class="top-buttons">
      <button type="submit">Send</button>
      <button type="button" id="micButton">üé§</button>
    </div>
    <button type="button" class="clear-button" id="clearButton">üóëÔ∏è¬†Clear</button>
  </div>
</form>

<!-- SCRIPT -->
<script>
/* ---------- DOM REFS ---------- */
const chatBox       = document.getElementById('chat');
const form          = document.getElementById('chat-form');
const input         = document.getElementById('messageInput');
const micButton     = document.getElementById('micButton');
const clearButton   = document.getElementById('clearButton');
const speakToggle   = document.getElementById('speakToggle');

/* ---------- STATE ---------- */
let conversation = [], studentName = '', thinkingRow = null;

/* ---------- UTILITIES ---------- */
function burstConfetti(){
  const el=document.createElement('div');
  el.id='cssConfetti'; el.textContent='üéâ';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1400);
}
function speak(text){
  if(!speakToggle.checked) return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang='en-NG';u.rate=1;u.pitch=1;speechSynthesis.speak(u);
}

/* ---------- ADD MESSAGE ---------- */
function addMessage(content, role){
  const row=document.createElement('div');row.className=`message-row ${role}`;
  const avatar=document.createElement('div');avatar.className=`avatar ${role}`;
  const bubble=document.createElement('div');bubble.className=`bubble ${role}`;
  bubble.innerHTML=content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');
  if(role==='user')bubble.setAttribute('data-name',studentName||'');
  row.appendChild(role==='assistant'?avatar:bubble);
  row.appendChild(role==='assistant'?bubble:avatar);
  chatBox.appendChild(row);
  chatBox.scrollTop=chatBox.scrollHeight;
  return row;
}

/* ---------- PROGRESS BAR (unchanged logic) ---------- */
function updateProgressBar(state='‚¨ú', mastered=0, total){
  const pv=document.getElementById('progressVisual');
  const pf=document.getElementById('progressFeedback');
  if(total===undefined) total=(state.match(/üü¢|üüß|‚¨ú/g)||[]).length;
  pv.textContent=`üß† Progress: ${state} (${mastered}/${total} mastered!)`;
  pf.textContent= mastered===0?"Let's begin your learning journey! üöÄ":
      mastered===total?"Woohoo! üéâ You've completed the topic!":
      "Great job! Keep going, you're doing well! üåü";
}
function updateProgressBarFromMessage(msg){
  const m=msg.match(/üß† Progress:\\s*(.*?)\\s*\\((\\d+)\\/(\\d+)/);
  if(m){const[,state,done,total]=m;updateProgressBar(state,+done,+total);}
  if(/You\\s+MASTERED/i.test(msg)){burstConfetti();}
}

/* ---------- KNOWLEDGE TREE ---------- */
function updateKnowledgeTreeInSidebar(txt){
  const lines=txt.split('\\n').filter(l=>/^\\d+\\./.test(l));
  if(!lines.length) return;
  document.getElementById('knowledgeHeader').style.display='block';
  document.getElementById('aboutMrE').style.display='none';
  document.getElementById('treeContents').innerHTML=
    '<ol style=\"padding-left:1rem\">'+lines.map(l=>`<li>${l.replace(/^\\d+\\.\\s*/,'')}</li>`).join('')+'</ol>';
  updateProgressBar('‚¨ú'.repeat(lines.length),0,lines.length);
}

/* ---------- ASSISTANT REPLY ---------- */
function handleAssistantReply(reply){
  addMessage(reply,'assistant');speak(reply);
  const idx=reply.indexOf('Knowledge Tree:');
  if(idx!==-1)updateKnowledgeTreeInSidebar(reply.slice(idx).split('\\n').slice(1).join('\\n'));
  updateProgressBarFromMessage(reply);
}

/* ---------- SEND MESSAGE ---------- */
async function sendMessage(msg){
  if(!studentName&&/my name is (\\w+)/i.test(msg))studentName=msg.match(/my name is (\\w+)/i)[1];
  conversation.push({role:'user',content:msg});addMessage(msg,'user');
  thinkingRow=addMessage('üí≠ Gov. is thinking...','assistant');
  try{
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversation})});
    const data=await res.json();let reply=data.message||'';
    reply=reply.replace(/Do you understand\\?.*?/gi,'Do you understand?');
    conversation.push({role:'assistant',content:reply});
    thinkingRow.remove();handleAssistantReply(reply);
  }catch{thinkingRow.remove();addMessage('‚ö†Ô∏è Something went wrong. Try again later.','assistant');}
}

/* ---------- INITIAL WELCOME ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  setTimeout(()=>{
    const intro='Welcome üéâ What‚Äôs your name, grade, and what topic would you like to learn today?';
    conversation.push({role:'assistant',content:intro});addMessage(intro,'assistant');
  },200);
});

/* ---------- FORM HANDLERS ---------- */
form.addEventListener('submit',e=>{
  e.preventDefault();const msg=input.value.trim();
  if(msg){input.value='';sendMessage(msg);}
});
input.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();form.dispatchEvent(new Event('submit'));}
});
input.addEventListener('input',()=>{
  input.style.height='auto';input.style.height=input.scrollHeight+'px';
});
clearButton.addEventListener('click',()=>{
  conversation=[];chatBox.innerHTML='';studentName='';document.dispatchEvent(new Event('DOMContentLoaded'));
});

/* ---------- VOICE INPUT ---------- */
const recognition='webkitSpeechRecognition'in window?new webkitSpeechRecognition():null;
if(recognition){
  recognition.lang='en-NG';recognition.continuous=false;recognition.interimResults=true;
  micButton.addEventListener('click',()=>{recognition.start();micButton.textContent='üéôÔ∏è'});
  recognition.onresult=e=>{
    let t='';for(let i=e.resultIndex;i<e.results.length;++i){if(e.results[i].isFinal)t+=e.results[i][0].transcript;}
    if(t.trim()){input.value=t;sendMessage(t);input.value='';}micButton.textContent='üé§';
  };
  recognition.onerror=recognition.onend=()=>{micButton.textContent='üé§'};
}else{micButton.disabled=true;micButton.title='Voice input not supported.';}
</script>
</body>
</html>
